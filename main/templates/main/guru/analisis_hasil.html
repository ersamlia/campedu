{% extends 'main/base.html' %}
{% load static %}

{% block title %}Analisis Hasil Belajar{% endblock %}

{% block custom_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
    body { background: #f4f7f6; font-family: 'Nunito', sans-serif; }

    /* HEADER */
    .page-header-card {
        background: #fff; border-radius: 15px; padding: 1.5rem 2rem;
        margin-bottom: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        display: flex; justify-content: space-between; align-items: center;
        border-left: 6px solid #4e73df;
    }
    .page-title { color: #2c3e50; font-weight: 800; font-size: 1.5rem; margin: 0; }
    .page-desc { color: #858796; font-size: 0.9rem; margin-top: 5px; }

    /* CARD STYLE */
    .stat-card {
        background: #fff; border-radius: 15px; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.3s;
        height: 100%; display: flex; flex-direction: column; overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    
    .card-top-decoration { height: 6px; width: 100%; }
    .deco-blue { background: linear-gradient(90deg, #4e73df, #224abe); } /* Latihan */
    .deco-red  { background: linear-gradient(90deg, #e74a3b, #c0392b); } /* Pengayaan/Ujian */

    .card-body-custom { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
    
    .card-meta { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .badge-pill-custom { padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    
    .badge-blue { background: #eef2ff; color: #4e73df; }
    .badge-red  { background: #fef2f2; color: #e74a3b; }

    .exam-title { font-size: 1.1rem; font-weight: 800; color: #2c3e50; margin-bottom: 1rem; }
    
    .big-stat-area { 
        text-align: center; margin: auto 0 1.5rem 0; padding: 1rem; 
        background: #f8f9fc; border-radius: 12px; border: 1px dashed #d1d3e2; 
    }
    .big-stat-val { font-size: 2.2rem; font-weight: 900; color: #5a5c69; margin-top: 5px; }
    .stat-details { display: flex; justify-content: space-around; margin-top: 10px; font-size: 0.85rem; color: #858796; }

    .btn-detail {
        width: 100%; border-radius: 10px; padding: 12px; font-weight: 800; font-size: 0.9rem;
        background: #fff; border: 2px solid #eaecf4; color: #6e707e; transition: 0.2s;
    }
    .btn-detail:hover { background: #4e73df; color: white; border-color: #4e73df; }

    /* MODAL STYLE */
    .modal-content-modern { border: none; border-radius: 20px; overflow: hidden; }
    .modal-header-modern { padding: 1.5rem 2rem; border-bottom: none; color: white; position: relative; }
    
    .header-latihan   { background: linear-gradient(135deg, #4e73df 0%, #2e59d9 100%); }
    .header-pengayaan { background: linear-gradient(135deg, #e74a3b 0%, #c0392b 100%); } /* Merah utk Pengayaan */
    
    .modal-title-modern { font-weight: 800; font-size: 1.25rem; margin-bottom: 5px; }
    .btn-close-white { color: white; opacity: 0.8; background: transparent; border: none; font-size: 1.5rem; position: absolute; top: 1.5rem; right: 1.5rem; }
    .modal-body-modern { background-color: #f8f9fc; padding: 1.5rem; max-height: 70vh; overflow-y: auto; }

    /* SISWA CARD */
    .student-card {
        background: #fff; border-radius: 12px; padding: 1rem 1.5rem;
        margin-bottom: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        border-left: 5px solid transparent; display: flex; justify-content: space-between; align-items: center;
    }
    .border-pass { border-left-color: #1cc88a; }
    .border-fail { border-left-color: #e74a3b; }
    .std-avatar {
        width: 40px; height: 40px; background: #eaecf4; color: #4e73df;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: 800; margin-right: 15px;
    }
    .status-badge { padding: 3px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
    .badge-pass { background: #d1fae5; color: #065f46; }
    .badge-fail { background: #fee2e2; color: #991b1b; }
</style>
{% endblock %}

{% block content %}

    <div class="page-header-card">
        <div>
            <h1 class="page-title">Analisis Hasil Belajar</h1>
            <div class="page-desc">Rekapitulasi hasil Latihan Harian & Pengayaan (Ujian Akhir).</div>
        </div>
        
        <div class="d-flex align-items-center">
            <a href="{% url 'download_analisis_pdf' %}" class="btn btn-danger mr-3 shadow-sm btn-sm" style="font-weight: 700; padding: 0.5rem 1rem;">
                <i class="fas fa-file-pdf mr-2"></i>Unduh PDF
            </a>
            <i class="fas fa-chart-line fa-3x text-gray-300"></i>
        </div>
    </div>

    <div class="row">
        {% for item in analisis_latihan %}
            
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="stat-card">
                    <div class="card-top-decoration {% if item.kategori == 'PENGAYAAN' %}deco-red{% else %}deco-blue{% endif %}"></div>
                    
                    <div class="card-body-custom">
                        <div class="card-meta">
                            <span class="badge-pill-custom {% if item.kategori == 'PENGAYAAN' %}badge-red{% else %}badge-blue{% endif %}">
                                {% if item.kategori == 'PENGAYAAN' %}UJIAN / PENGAYAAN{% else %}LATIHAN SOAL{% endif %}
                            </span>
                            
                            {% if item.kategori == 'PENGAYAAN' %}
                                <i class="fas fa-file-signature text-gray-300"></i>
                            {% else %}
                                <i class="fas fa-book-open text-gray-300"></i>
                            {% endif %}
                        </div>

                        <h5 class="exam-title">{{ item.judul }}</h5>
                        
                        <div class="big-stat-area">
                            <span class="big-stat-label">Rata-rata Kelas</span>
                            <div class="big-stat-val {% if item.kategori == 'PENGAYAAN' %}text-danger{% else %}text-primary{% endif %}">
                                {{ item.rata_rata|default:"0"|floatformat:1 }}
                            </div>
                            <div class="stat-details mt-2">
                                <span><i class="fas fa-users text-primary"></i> {{ item.daftar_nilai|length }} Siswa</span>
                                <span><i class="fas fa-check-circle text-success"></i> Tuntas: {{ item.jumlah_lulus }}</span>
                            </div>
                        </div>

                        <button class="btn-detail" data-toggle="modal" data-target="#modal-{{ forloop.counter }}">
                            <i class="fas fa-list-alt mr-2"></i> Lihat Daftar Nilai
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modal-{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content modal-content-modern">
                        <div class="modal-header-modern {% if item.kategori == 'PENGAYAAN' %}header-pengayaan{% else %}header-latihan{% endif %}">
                            <div>
                                <h5 class="modal-title-modern">{{ item.judul }}</h5>
                                <div class="modal-subtitle">
                                    <i class="fas fa-user-graduate mr-1"></i> Daftar Nilai Siswa
                                </div>
                            </div>
                            <button type="button" class="btn-close-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        
                        <div class="modal-body-modern">
                            {% for siswa in item.daftar_nilai %}
                            <div class="student-card {% if siswa.nilai >= 70 %}border-pass{% else %}border-fail{% endif %}">
                                <div style="display:flex; align-items:center;">
                                    <div class="std-avatar">{{ siswa.nama|slice:":1" }}</div>
                                    <div>
                                        <div style="font-weight:700; color:#2c3e50;">{{ siswa.nama }}</div>
                                        <div style="font-size:0.8rem; color:#888;">
                                            <i class="far fa-clock mr-1"></i>
                                            {% if siswa.tanggal_submit %}
                                                {{ siswa.tanggal_submit|date:"d M Y" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:1.4rem; font-weight:900; line-height:1;"
                                         class="{% if siswa.nilai >= 70 %}text-success{% else %}text-danger{% endif %}">
                                         {{ siswa.nilai|floatformat:0 }}
                                    </div>
                                    <span class="status-badge {% if siswa.nilai >= 70 %}badge-pass{% else %}badge-fail{% endif %}">
                                        {% if siswa.nilai >= 70 %}TUNTAS{% else %}REMEDIAL{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-5">
                                <i class="fas fa-ghost fa-3x text-gray-300 mb-3"></i>
                                <p class="text-muted">Belum ada siswa yang mengerjakan.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

        {% empty %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-folder-open fa-3x text-gray-300 mb-3"></i>
                <h5 class="text-muted">Belum ada data Latihan atau Pengayaan.</h5>
            </div>
        {% endfor %}
    </div>

{% endblock %}

{% block custom_js %}
{% endblock %}
