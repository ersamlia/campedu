{% extends 'main/base.html' %}
{% load static %}

{% block title %}Modul 1: {{ subbab.judul }}{% endblock %}

{% block custom_css %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

body {
    font-family: 'Nunito', sans-serif;
    background: #f3f6fd;
}

/* === HEADER CARD === */
.modul-header-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.6rem;
    background: #fff;
    padding: 1.1rem 1.5rem;
    border-radius: 1.2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.modul-header-title {
    font-family: 'Nunito', sans-serif;
    color: #22356f;
    font-weight: 900;
    font-size: 1.28rem;
    margin-bottom: 3px;
}
.modul-header-keterangan {
    font-size: 0.92rem;
    color: #7a849c;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* === LEARNING CARD & SLIDES === */
.learning-slide { display: none; }
.learning-slide.active { display: block !important; width: 100%; animation: fadeInSlide 0.5s; }

@keyframes fadeInSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.learning-card {
    background: #fff;
    border-radius: 2.2rem;
    box-shadow: 0 8px 32px rgba(53,99,233,0.10);
    padding: 2.6rem 5vw 2.2rem 5vw;
    width: 100%;
    margin: 0 auto 2.5rem auto;
}

/* Responsive Padding */
@media (max-width: 900px) {
    .learning-card { padding: 1.5rem 1rem; border-radius: 1.2rem; }
    .modul-header-card { padding: 0.8rem; }
}

.learning-card .card-header {
    background: transparent;
    border: none;
    padding: 0;
    margin-bottom: 1.2rem;
}
.learning-card .card-header h6 {
    color: #246bfd;
    font-size: 1.1rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Typography Content */
.learning-card h4, .learning-card h5 {
    color: #1c253b;
    font-weight: 800;
    margin-bottom: 0.8rem;
}
.learning-card p, .learning-card li {
    color: #495466;
    font-size: 1.05rem;
    line-height: 1.6;
}

/* Buttons & Forms */
.btn { border-radius: 0.85rem; font-weight: 700; padding: 0.6rem 1.2rem; transition: all 0.2s; }
.btn-primary { background-color: #246bfd; border: none; }
.btn-primary:hover { background-color: #1a54ca; transform: translateY(-2px); }
.form-control {
    border-radius: 0.8rem;
    border: 1px solid #eaf0fb;
    padding: 1rem;
    background: #f7fbff;
}
.form-control:focus { background: #fff; border-color: #246bfd; box-shadow: none; }

/* === KHUSUS CHECKLIST INTERAKTIF === */
.checklist-container {
    background: #fff;
    border: 1px solid #e3e6f0;
    border-radius: 1rem;
    overflow: hidden;
}
.ciri-item {
    padding: 1rem 1.2rem;
    border-bottom: 1px solid #f0f2f5;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    transition: background 0.3s;
}
.ciri-item:last-child { border-bottom: none; }
.ciri-item:hover { background-color: #fcfdfe; }

.ciri-label {
    font-weight: 700;
    color: #2e59d9;
    font-size: 1rem;
    display: block;
}
.ciri-text {
    font-size: 0.9rem;
    margin-top: 8px;
    display: none;
    border-radius: 0.6rem;
    padding: 0.6rem 0.8rem;
}
.ciri-text.show { display: block; animation: fadeInText 0.4s; }

@keyframes fadeInText {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.btn-cek {
    border-radius: 50px;
    padding: 0.3rem 1.2rem;
    font-size: 0.85rem;
}

/* === STYLE GAMBAR YANG DIPERBESAR & FULL === */

/* Gambar Thumbnail di Slide 3 */
.stim-img {
    height: 220px; /* Lebih tinggi dari sebelumnya */
    width: 100%;
    object-fit: cover; /* Mengisi penuh kotak (crop jika perlu) */
    border-radius: 1rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    padding: 0; /* Hapus padding agar full ke pinggir */
    border: none;
}

/* Gambar Utama di Slide 4 (Analisis) */
#obj-img {
    width: 100%;
    height: 350px; /* Ukuran FIX yang besar */
    object-fit: contain; /* Pastikan seluruh objek terlihat (tidak terpotong) */
    background-color: #fff; 
    border-radius: 1rem;
    padding: 0; /* Full box */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
}

/* Container text dibawah gambar Slide 3 */
.caption-img {
    margin-top: 10px;
    font-weight: 800;
    color: #4e73df;
    font-size: 1.1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="modul-header-card">
    <div>
        <div class="modul-header-title">Modul 1: {{ subbab.judul }}</div>
        <div class="modul-header-keterangan">
            {{ subbab.deskripsi|default:"Mengenal Ciri-Ciri Makhluk Hidup" }}
        </div>
    </div>
</div>

<div id="slide-1" class="learning-slide active">
    <div class="learning-card">
        <div class="card-header">
            <h6>Tujuan Pembelajaran</h6>
        </div>
        <div class="card-body">
            <h4 class="mb-4">Selamat Datang!</h4>
            <p>Setelah menyelesaikan modul interaktif ini, Anda diharapkan mampu:</p>
            <ul>
                <li>Membedakan benda hidup dan benda mati berdasarkan pengamatan.</li>
                <li>Mengidentifikasi 7 ciri utama yang dimiliki oleh makhluk hidup.</li>
                <li>Menyimpulkan pengertian makhluk hidup berdasarkan data yang dikumpulkan.</li>
            </ul>
            <hr class="my-4">
            <button class="btn btn-primary btn-lg shadow-sm" onclick="showSlide(2)">Mulai Belajar <i class="fas fa-arrow-right ml-2"></i></button>
        </div>
    </div>
</div>

<div id="slide-2" class="learning-slide">
    <div class="learning-card">
        <div class="card-header">
            <h6>Pemaparan Materi Singkat</h6>
        </div>
        <div class="card-body">
            <h5>Apa itu Makhluk Hidup?</h5>
            <p>Di sekitar kita, terdapat banyak sekali benda. Ada benda yang dapat tumbuh besar dan bergerak sendiri seperti Kucing. Ada juga benda yang diam saja seperti Batu.</p>
            <p class="mb-4">Benda-benda yang memiliki kemampuan untuk bernapas, bergerak, makan, tumbuh, dan berkembang biak kita sebut sebagai <b>makhluk hidup</b>. Benda yang tidak memilikinya kita sebut <b>benda mati</b>.</p>
            
            <div class="alert alert-info border-0 shadow-sm" role="alert">
                <i class="fas fa-info-circle mr-2"></i> <strong>Tantangan:</strong> Ayo kita temukan sendiri apa saja ciri-ciri pasti dari makhluk hidup!
            </div>
            
            <div class="mt-4">
                <button class="btn btn-light text-primary mr-2" onclick="showSlide(1)"><i class="fas fa-arrow-left"></i> Kembali</button>
                <button class="btn btn-primary" onclick="showSlide(3)">Lanjut ke Aktivitas <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="slide-3" class="learning-slide">
    <div class="learning-card">
        <div class="card-header">
            <h6>Tahap 1: Pengamatan</h6>
        </div>
        <div class="card-body">
            <p>Perhatikan 4 gambar di bawah ini. Menurutmu, mana yang makhluk hidup dan mana yang benda mati?</p>
            <div class="row text-center mt-4">
                <div class="col-md-3 mb-4">
                    <img src="{% static 'img/pohon2.jpg' %}" class="img-fluid stim-img" alt="Pohon">
                    <div class="caption-img">Pohon</div>
                </div>
                <div class="col-md-3 mb-4">
                    <img src="{% static 'img/batu2.jpg' %}" class="img-fluid stim-img" alt="Batu">
                    <div class="caption-img">Batu</div>
                </div>
                <div class="col-md-3 mb-4">
                    <img src="{% static 'img/burung.png' %}" class="img-fluid stim-img" alt="Burung">
                    <div class="caption-img">Burung</div>
                </div>
                <div class="col-md-3 mb-4">
                    <img src="{% static 'img/mobil2.jpg' %}" class="img-fluid stim-img" alt="Mobil">
                    <div class="caption-img">Mobil</div>
                </div>
            </div>
            
            <div class="bg-light p-3 rounded mt-2">
                <h6 class="text-primary font-weight-bold">Pertanyaan Pemantik:</h6>
                <ul class="mb-0">
                    <li>"Pohon diam saja, apakah dia hidup?"</li>
                    <li>"Mobil bisa bergerak, Burung juga bergerak. Apakah keduanya makhluk hidup?"</li>
                </ul>
            </div>

            <div class="mt-4">
                <button class="btn btn-light text-primary mr-2" onclick="showSlide(2)"><i class="fas fa-arrow-left"></i> Kembali</button>
                <button class="btn btn-primary" onclick="showSlide(4)">Lanjut ke Eksplorasi <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="slide-4" class="learning-slide">
    <div class="learning-card">
        <div class="card-header">
            <h6>Tahap 2: Eksplorasi & Penemuan (Data Collection)</h6>
        </div>
        <div class="card-body" id="interactive-area">
            <p>Mari kita buktikan! Klik tombol <b>"Cek"</b> pada setiap ciri untuk melihat apakah objek tersebut memilikinya.</p>
            
            <div class="row">
                <div class="col-md-5 text-center mb-4">
                    <div class="p-3 bg-light rounded border sticky-top" style="top: 20px; z-index: 1;">
                        <h4 id="obj-title" class="text-gray-900 font-weight-bold mb-3">Objek 1: Pohon</h4>
                        
                        <img id="obj-img" src="{% static 'img/pohon.png' %}" alt="Objek">
                        
                        <div id="result-area" style="display:none;" class="mt-4">
                            <h6 class="font-weight-bold text-gray-800">Hasil Analisis:</h6>
                            <div id="obj-result-badge" class="badge badge-success p-3" style="font-size: 1.1rem; width: 100%;">MAKHLUK HIDUP</div>
                        </div>

                        <button id="next-obj-btn" class="btn btn-info btn-block mt-3 py-2" style="display:none;">
                            Analisis Objek Berikutnya <i class="fas fa-arrow-right"></i>
                        </button>
                         <button id="finish-modul-btn" class="btn btn-success btn-block mt-3 py-2" style="display:none;" onclick="showSlide(5)">
                            Lanjut ke Kesimpulan <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-7">
                    <h5 class="text-gray-900 mb-3 ml-1">Daftar Ciri-Ciri:</h5>
                    <div id="checklist-container" class="checklist-container shadow-sm">
                        <div class="p-5 text-center text-muted">Memuat data...</div>
                    </div>
                </div>
            </div>

            <hr class="mt-5">
            <button class="btn btn-light text-primary" onclick="showSlide(3)"><i class="fas fa-arrow-left"></i> Kembali</button>
        </div>
    </div>
</div>

<div id="slide-5" class="learning-slide">
    <div class="learning-card">
        <div class="card-header">
            <h6>Tahap 3: Verifikasi & Kesimpulan</h6>
        </div>
        <div class="card-body">
            <h5>Verifikasi Data</h5>
            <p>Dari aktivitas sebelumnya, kita telah menganalisis Pohon, Batu, Burung, dan Mobil. Hasilnya:</p>
            <div class="row mb-3">
                <div class="col-md-6 mb-2">
                    <div class="alert alert-success">
                        <strong>Makhluk Hidup:</strong> <br> Burung & Pohon. <small>(Memiliki 7 Ciri)</small>
                    </div>
                </div>
                <div class="col-md-6 mb-2">
                    <div class="alert alert-secondary">
                        <strong>Benda Mati:</strong> <br> Batu & Mobil. <small>(Tidak memiliki ciri biologis)</small>
                    </div>
                </div>
            </div>
            
            <p>Jadi, syarat mutlak makhluk hidup adalah memiliki ciri:</p>
            <ol class="columns-2" style="column-count: 2;">
                <li>Bernapas</li>
                <li>Bergerak</li>
                <li>Butuh Makan (Nutrisi)</li>
                <li>Tumbuh & Berkembang</li>
                <li>Berkembang Biak</li>
                <li>Peka Terhadap Rangsang</li>
                <li>Ekskresi (Zat Sisa)</li>
            </ol>
            <hr>
            
            <h5>Kesimpulan Akhir</h5>
            <p>Berdasarkan pemahamanmu, tuliskan pengertian makhluk hidup:</p>
            <form>
                <div class="form-group">
                    <textarea class="form-control" rows="3" 
                              placeholder="Menurut saya, Makhluk hidup adalah..." 
                              id="kesimpulan_text" 
                              oninput="checkKesimpulan()"></textarea>
                    <small id="kesimpulan_error" class="text-danger mt-1" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Mohon tulis kesimpulan minimal 10 karakter.
                    </small>
                </div>
            </form>
            
            <div class="d-flex justify-content-between align-items-center mt-4">
                <button class="btn btn-light text-primary" onclick="showSlide(4)"><i class="fas fa-arrow-left"></i> Kembali</button>
                
                <a href="{% url 'selesai_step' 'modul_1' %}" 
                   id="btn_selesai_modul" 
                   class="btn btn-success disabled shadow-sm">
                    Selesai & Lanjut <i class="fas fa-check-circle ml-2"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
/* === LOGIKA NAVIGASI SLIDE === */
let currentSlide = 1;

function showSlide(slideNumber) {
    document.getElementById('slide-' + currentSlide).classList.remove('active');
    currentSlide = slideNumber;
    document.getElementById('slide-' + currentSlide).classList.add('active');
    document.querySelector('.modul-header-card').scrollIntoView({ behavior: 'smooth' });
    if (slideNumber === 5) { checkKesimpulan(); }
}

/* === LOGIKA VALIDASI KESIMPULAN === */
function checkKesimpulan() {
    const textarea = document.getElementById('kesimpulan_text');
    const button = document.getElementById('btn_selesai_modul');
    const errorMsg = document.getElementById('kesimpulan_error');
    
    if (textarea.value.trim().length >= 10) {
        button.classList.remove('disabled');
        button.style.pointerEvents = 'auto';
        button.style.opacity = '1';
        errorMsg.style.display = 'none';
    } else {
        button.classList.add('disabled');
        button.style.pointerEvents = 'none';
        button.style.opacity = '0.6';
        if(textarea.value.length > 0) {
            errorMsg.style.display = 'block';
        } else {
            errorMsg.style.display = 'none';
        }
    }
}

/* === DATA OBJEK (4 OBJEK: POHON, BATU, BURUNG, MOBIL) === */
const objects = {
    'Pohon': {
        img: "{% static 'img/pohon.png' %}",
        type: 'living', 
        ciri: {
            'Bernapas': { status: true, teks: 'YA! Tumbuhan bernapas melalui pori-pori daun (stomata).' },
            'Bergerak': { status: true, teks: 'YA! Tumbuhan bergerak tumbuh ke arah cahaya, walau tidak berpindah tempat.' },
            'Butuh Makan/Nutrisi': { status: true, teks: 'YA! Tumbuhan membuat makanan sendiri (fotosintesis) dan menyerap zat hara.' },
            'Tumbuh & Berkembang': { status: true, teks: 'YA! Dari biji kecil tumbuh menjadi pohon besar.' },
            'Berkembang Biak': { status: true, teks: 'YA! Pohon menghasilkan biji atau tunas.' },
            'Peka Terhadap Rangsang': { status: true, teks: 'YA! Akar peka terhadap air, daun peka terhadap cahaya.' },
            'Mengeluarkan Zat Sisa': { status: true, teks: 'YA! Tumbuhan mengeluarkan uap air dan oksigen.' }
        },
        kesimpulan: "MAKHLUK HIDUP"
    },
    'Batu': {
        img: "{% static 'img/batu.png' %}",
        type: 'non-living',
        ciri: {
            'Bernapas': { status: false, teks: 'TIDAK! Batu adalah benda padat yang tidak bernapas.' },
            'Bergerak': { status: false, teks: 'TIDAK! Batu diam saja, kecuali dilempar atau terkena gempa.' },
            'Butuh Makan/Nutrisi': { status: false, teks: 'TIDAK! Batu tidak butuh makanan.' },
            'Tumbuh & Berkembang': { status: false, teks: 'TIDAK! Ukuran batu tidak bertambah besar dengan sendirinya.' },
            'Berkembang Biak': { status: false, teks: 'TIDAK! Batu tidak bisa punya anak batu.' },
            'Peka Terhadap Rangsang': { status: false, teks: 'TIDAK! Batu tidak bereaksi jika dipukul (selain pecah).' },
            'Mengeluarkan Zat Sisa': { status: false, teks: 'TIDAK! Batu tidak mengeluarkan kotoran.' }
        },
        kesimpulan: "BENDA MATI"
    },
    'Burung': {
        img: "{% static 'img/burung.png' %}",
        type: 'living', 
        ciri: {
            'Bernapas': { status: true, teks: 'YA! Burung bernapas menghirup oksigen dengan paru-paru.' },
            'Bergerak': { status: true, teks: 'YA! Burung terbang menggunakan sayap dan ototnya.' },
            'Butuh Makan/Nutrisi': { status: true, teks: 'YA! Burung perlu makan biji atau serangga untuk energi.' },
            'Tumbuh & Berkembang': { status: true, teks: 'YA! Dari telur menetas menjadi burung kecil lalu dewasa.' },
            'Berkembang Biak': { status: true, teks: 'YA! Burung bertelur menghasilkan keturunan.' },
            'Peka Terhadap Rangsang': { status: true, teks: 'YA! Burung kabur jika melihat pemangsa mendekat.' },
            'Mengeluarkan Zat Sisa': { status: true, teks: 'YA! Burung mengeluarkan kotoran dari tubuhnya.' }
        },
        kesimpulan: "MAKHLUK HIDUP"
    },
    'Mobil': {
        img: "{% static 'img/mobil.png' %}",
        type: 'non-living',
        ciri: {
            'Bernapas': { status: false, teks: 'TIDAK! Asap knalpot itu polusi, bukan pernapasan sel.' },
            'Bergerak': { status: true, teks: 'YA! Mobil bergerak, TAPI harus digerakkan mesin & manusia.' },
            'Butuh Makan/Nutrisi': { status: false, teks: 'TIDAK! Bensin adalah bahan bakar, bukan nutrisi biologis.' },
            'Tumbuh & Berkembang': { status: false, teks: 'TIDAK! Mobil tidak bisa bertambah besar sendiri.' },
            'Berkembang Biak': { status: false, teks: 'TIDAK! Mobil dibuat di pabrik, tidak bisa beranak.' },
            'Peka Terhadap Rangsang': { status: false, teks: 'TIDAK! Sensor mobil adalah listrik, bukan rasa sakit/takut.' },
            'Mengeluarkan Zat Sisa': { status: false, teks: 'TIDAK! Sisa pembakaran mesin berbeda dengan ekskresi.' }
        },
        kesimpulan: "BENDA MATI"
    }
};

let clickedCount = 0;
const totalCiri = 7;

/* === LOGIKA INTERAKTIF (LOAD OBJEK) === */
function loadObject(namaObjek) {
    const obj = objects[namaObjek];
    const container = document.getElementById('checklist-container');
    const nextBtn = document.getElementById('next-obj-btn');
    
    // 1. Reset Tampilan
    document.getElementById('obj-title').innerText = `Objek: ${namaObjek}`;
    document.getElementById('obj-img').src = obj.img;
    document.getElementById('result-area').style.display = 'none';
    nextBtn.style.display = 'none';
    document.getElementById('finish-modul-btn').style.display = 'none';
    
    // Set Target Tombol Berikutnya
    if(namaObjek === 'Pohon') {
        nextBtn.onclick = function() { loadObject('Batu'); };
    } else if (namaObjek === 'Batu') {
        nextBtn.onclick = function() { loadObject('Burung'); };
    } else if (namaObjek === 'Burung') {
        nextBtn.onclick = function() { loadObject('Mobil'); };
    }
    
    container.innerHTML = "";
    clickedCount = 0;
    
    // 2. Generate Item Checklist
    for (const [ciriName, data] of Object.entries(obj.ciri)) {
        const safeID = ciriName.replace(/\s/g, '').replace(/\//g, '');
        const itemHTML = `
            <div class="ciri-item">
                <div style="flex-grow: 1;">
                    <span class="ciri-label">${ciriName}?</span>
                    <div id="res-text-${safeID}" class="ciri-text alert alert-light border mt-2">
                        ${data.teks}
                    </div>
                </div>
                <div style="margin-left: 15px; min-width: 100px; text-align: right;">
                    <button class="btn btn-outline-primary btn-cek shadow-sm" 
                            id="btn-cek-${safeID}"
                            onclick="checkCiri(this, '${namaObjek}', '${safeID}', ${data.status})">
                        <i class="fas fa-search mr-1"></i> Cek
                    </button>
                    <span id="badge-${safeID}" style="display:none;" class="badge p-2 animated bounceIn"></span>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHTML);
    }
}

/* === LOGIKA SAAT TOMBOL CEK DIKLIK === */
function checkCiri(btnElement, namaObjek, safeID, status) {
    const textDiv = document.getElementById(`res-text-${safeID}`);
    const badgeSpan = document.getElementById(`badge-${safeID}`);
    
    btnElement.style.display = 'none';
    badgeSpan.style.display = 'inline-block';
    
    if (status) {
        badgeSpan.className = 'badge badge-success p-2';
        badgeSpan.innerHTML = '<i class="fas fa-check"></i> YA';
        textDiv.classList.remove('alert-light');
        textDiv.classList.add('alert-success');
    } else {
        badgeSpan.className = 'badge badge-danger p-2';
        badgeSpan.innerHTML = '<i class="fas fa-times"></i> TIDAK';
        textDiv.classList.remove('alert-light');
        textDiv.classList.add('alert-danger');
    }
    
    textDiv.classList.add('show');
    clickedCount++;
    
    if (clickedCount === totalCiri) {
        setTimeout(() => showConclusion(namaObjek), 800);
    }
}

/* === TAMPILKAN KESIMPULAN OBJEK === */
function showConclusion(namaObjek) {
    const resultArea = document.getElementById('result-area');
    const resultBadge = document.getElementById('obj-result-badge');
    const objData = objects[namaObjek];

    resultArea.style.display = 'block';
    resultBadge.innerText = objData.kesimpulan;
    
    if (objData.kesimpulan === "MAKHLUK HIDUP") {
        resultBadge.className = "badge badge-success p-3 w-100 shadow";
    } else {
        resultBadge.className = "badge badge-secondary p-3 w-100 shadow";
    }

    // Logic Tombol Lanjut
    if (namaObjek === 'Mobil') {
        document.getElementById('finish-modul-btn').style.display = 'block';
        document.getElementById('finish-modul-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        const nextBtn = document.getElementById('next-obj-btn');
        nextBtn.style.display = 'block';
        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Init Load
window.addEventListener("DOMContentLoaded", function() { 
    loadObject('Pohon'); 
});
</script>
{% endblock %}