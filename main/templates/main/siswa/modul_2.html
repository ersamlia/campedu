{% extends 'main/base.html' %}
{% load static %}

{% block title %}Materi 2: Klasifikasi Makhluk Hidup{% endblock %}

{% block custom_css %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
body { font-family: 'Nunito', sans-serif; background: #f0f8ff; }

/* === HEADER === */
.modul-header-card {
    background: white; padding: 1.2rem; border-radius: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem;
    border-left: 6px solid #4e73df; display: flex; justify-content: space-between; align-items: center;
}
.step-badge {
    background: #eef2ff; color: #4e73df; padding: 8px 16px; border-radius: 30px;
    font-weight: 800; letter-spacing: 0.5px; border: 1px solid #d1d3e2;
}

/* === LEARNING CARD === */
.learning-slide { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
.learning-slide.active { display: block; opacity: 1; }

.learning-card {
    background: white; border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    padding: 3rem; position: relative; overflow: hidden;
}

h3.title-highlight { color: #2e59d9; font-weight: 900; margin-bottom: 1rem; }
p.text-content { font-size: 1.1rem; color: #555; line-height: 1.8; }

/* === Tambahan Styling Sumber Gambar MINIMALIS === */
.image-source {
    font-size: 0.7rem;
    color: #888;
    margin-top: 5px;
    display: block;
    text-align: center;
    font-style: italic;
}
.comparison-body { padding: 15px; } 

/* === SLIDE 1: STIMULASI === */
.comparison-wrapper { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
.comparison-card {
    flex: 1; min-width: 250px; border: 2px solid #eaecf4; border-radius: 15px; 
    overflow: hidden; text-align: center; transition: 0.3s; cursor: pointer;
}
.comparison-card:hover { border-color: #4e73df; transform: translateY(-5px); }
.comparison-card img { width: 100%; height: 200px; object-fit: cover; }
.check-list { text-align: left; margin-top: 10px; font-size: 0.9rem; }
.check-item { margin-bottom: 5px; display: flex; align-items: center; }

/* === SLIDE 2: MIKROSKOP === */
.microscope-area {
    background: #1a1a1a; border-radius: 20px; padding: 20px; color: white;
    display: flex; flex-direction: column; align-items: center; position: relative;
}
.lens-circle {
    width: 300px; height: 300px; border: 5px solid #555; border-radius: 50%;
    overflow: hidden; background: black; box-shadow: 0 0 20px rgba(255,255,255,0.1);
    margin-bottom: 20px; 
    position: relative;
}
.lens-circle video, .lens-circle img { width: 100%; height: 100%; object-fit: cover; }
.preparat-controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
.btn-preparat {
    background: #333; border: 1px solid #555; color: white; padding: 8px 15px;
    border-radius: 20px; transition: 0.3s; font-size: 0.9rem;
}
.btn-preparat:hover, .btn-preparat.active { background: #4e73df; border-color: #4e73df; }

/* === SLIDE 3: KUNCI DIKOTOM === */
.dikotom-container {
    max-width: 750px; margin: 0 auto; background: #f8f9fc; border-radius: 15px; 
    padding: 30px; border: 2px solid #e3e6f0; text-align: center;
}
.plant-display {
    display: inline-block; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-radius: 15px; overflow: hidden; margin-bottom: 20px; 
    width: 200px; height: 200px;
}
.plant-display img { width: 100%; height: 100%; object-fit: cover; }
.question-text { font-size: 1.25rem; font-weight: 800; color: #2e59d9; margin-bottom: 20px; }
.btn-choice {
    display: block; width: 100%; margin-bottom: 10px; padding: 12px;
    background: white; border: 2px solid #d1d3e2; border-radius: 10px;
    text-align: left; font-weight: 700; color: #555; transition: 0.2s; cursor: pointer;
    position: relative;
}
.btn-choice:hover { border-color: #1cc88a; color: #1cc88a; background: #f0fcf6; transform: translateX(5px); }
.breadcrumb-dikotom { font-size: 0.85rem; color: #888; margin-bottom: 15px; font-style: italic; }

/* === SLIDE 4: TAKSON === */
.takson-pyramid { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.takson-level {
    width: 100%; text-align: center; padding: 12px; 
    color: white; font-weight: 800; background-color: #4e73df; 
    border-radius: 8px; cursor: pointer; transition: 0.3s;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1); letter-spacing: 1px;
    border: 1px solid #2e59d9; text-transform: uppercase; 
}
.takson-info-box {
    background: #fff; border-left: 6px solid #1cc88a; padding: 30px; 
    border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); height: 100%;
    display: flex; flex-direction: column; justify-content: flex-start;
    transition: all 0.3s ease;
}
.takson-latin-box { text-align: center; margin-bottom: 5px; font-weight: 900; }
.takson-latin-box .takson-label { font-size: 1.1rem; color: #858796; font-weight: 700; }
.takson-latin-plant { font-size: 1.6rem; color: #1cc88a; }
.takson-latin-animal { font-size: 1.6rem; color: #4e73df; }
.takson-indo { 
    font-size: 1.1rem; color: #858796; font-weight: 700; margin-bottom: 20px; 
    text-transform: uppercase; letter-spacing: 1px; text-align: center; 
    border-bottom: 1px solid #eee; padding-bottom: 10px;
}
.takson-image-card {
    text-align: center; padding: 10px; border: 1px solid #eee; border-radius: 8px;
    margin-bottom: 15px; background: #fff; height: 100%;
}
.takson-image-card img {
    width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;
}
.takson-image-card .caption { font-size: 0.9rem; font-weight: 700; color: #4e73df; }
.takson-image-card .sub-caption { font-size: 0.75rem; color: #858796; margin-top: 5px; display: block; }
.takson-group-title {
    font-weight: 900 !important; padding-bottom: 5px; border-bottom: 2px solid #e3e6f0; color: #2e59d9;
}

/* === PAGINATION FOOTER === */
.pagination-footer {
    margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e3e6f0;
    display: flex; justify-content: space-between; align-items: center;
    flex-wrap: wrap; gap: 10px;
}
.page-numbers-container { display: flex; gap: 5px; }
.btn-page-number {
    width: 35px; height: 35px; border-radius: 50%;
    border: 1px solid #d1d3e2; background: #fff;
    color: #858796; font-weight: 700; font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s; cursor: pointer;
}
.btn-page-number.active { background: #4e73df; color: white; border-color: #4e73df; box-shadow: 0 4px 10px rgba(78, 115, 223, 0.3); }
.btn-page-number.unlocked { background: #eefdf6; color: #1cc88a; border-color: #1cc88a; }
.btn-page-number.unlocked:hover { background: #1cc88a; color: white; }
.btn-page-number:disabled { background: #eaecf4; color: #b7b9cc; border-color: #eaecf4; cursor: not-allowed; opacity: 0.7; }
.btn-nav-page { border-radius: 50px; font-weight: 700; padding: 8px 20px; font-size: 0.9rem; transition: 0.2s; }

@media (max-width: 576px) {
    .lens-circle { width: 250px; height: 250px; }
    .takson-image-card img { height: 120px; } 
    .takson-latin-plant, .takson-latin-animal { font-size: 1.4rem; }
    .takson-latin-box .takson-label { font-size: 0.9rem; }
    
    /* Mobile Pagination */
    .pagination-footer { flex-direction: column-reverse; }
    .page-numbers-container { order: 2; margin-bottom: 10px; }
    .btn-nav-page { width: 100%; order: 1; }
}
</style>
{% endblock %}

{% block content %}

<div class="modul-header-card sticky-top" style="top: 15px; z-index: 99;">
    <div>
        <h5 class="font-weight-bold text-primary m-0"><i class="fas fa-sitemap mr-2"></i>Materi 2: Klasifikasi Makhluk Hidup</h5>
    </div>
    <div id="step-badge" class="step-badge">1. Ciri Kehidupan</div>
</div>

<div id="slide-1" class="learning-slide active">
    <div class="learning-card">
        <h3 class="title-highlight text-center">Mobil vs Kucing: Mana yang Hidup?</h3>
        <p class="text-content text-center mb-4">
            Perhatikan Mobil dan Kucing di bawah ini. Keduanya bisa bergerak. 
            Apakah keduanya Makhluk Hidup? <b>Klik gambar</b> untuk mengecek cirinya!
        </p>

        <div class="comparison-wrapper">
            <div class="comparison-card" onclick="checkCiri('mobil')">
                <img src="{% static 'img/mobil.png' %}" alt="Mobil">
                <div class="comparison-body">
                    <h5 class="font-weight-bold">Mobil</h5>
                    <small class="image-source">Sumber: Dokumen Canva</small> 
                    <div id="list-mobil" style="display:none;" class="check-list">
                        <div class="check-item"><i class="fas fa-check text-success mr-2"></i> Bergerak? (Ya)</div>
                        <div class="check-item"><i class="fas fa-times text-danger mr-2"></i> Bernapas? (Tidak)</div>
                        <div class="check-item"><i class="fas fa-times text-danger mr-2"></i> Tumbuh Besar? (Tidak)</div>
                    </div>
                    <div id="res-mobil" class="alert alert-secondary mt-3 p-2" style="display:none;">
                        <b>BENDA TAK HIDUP</b> 
                    </div>
                </div>
            </div>

            <div class="comparison-card" onclick="checkCiri('kucing')">
                <img src="{% static 'img/kucing.jpeg' %}" alt="Kucing">
                <div class="comparison-body">
                    <h5 class="font-weight-bold">Kucing</h5>
                    <small class="image-source">Sumber: Dokumen Canva</small> 
                    <div id="list-kucing" style="display:none;" class="check-list">
                        <div class="check-item"><i class="fas fa-check text-success mr-2"></i> Bergerak? (Ya)</div>
                        <div class="check-item"><i class="fas fa-check text-success mr-2"></i> Bernapas? (Ya)</div>
                        <div class="check-item"><i class="fas fa-check text-success mr-2"></i> Tumbuh Besar? (Ya)</div>
                    </div>
                    <div id="res-kucing" class="alert alert-success mt-3 p-2" style="display:none;">
                        <b>MAKHLUK HIDUP</b> 
                    </div>
                </div>
            </div>
        </div>

        <div class="pagination-footer">
            <button class="btn btn-outline-secondary btn-nav-page" onclick="changePage(-1)" disabled>
                <i class="fas fa-chevron-left"></i> Kembali
            </button>
            <div class="page-numbers-container" id="page-numbers-1"></div>
            <button id="btn-next-1" class="btn btn-outline-primary btn-nav-page" onclick="changePage(1)" disabled>
                Selanjutnya <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<div id="slide-2" class="learning-slide">
    <div class="learning-card">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h3 class="title-highlight">Ayo Mengamati</h3>
                <p class="text-content">
                    Setelah mengamati makhluk hidup dan tak hidup, mari kita amati organisme yang sangat kecil! 
                    Amati sampel di bawah ini untuk mengidentifikasi ciri-ciri <b>Kingdom Monera</b>, <b>Protista</b>, dan <b>Fungi</b> berdasarkan struktur selnya.
                </p>
                
                <div class="mt-4">
                    <h6 class="font-weight-bold mb-3">Pilih Sampel Preparat:</h6>
                    <div class="preparat-controls justify-content-start">
                        <button class="btn btn-preparat" onclick="setMicroscope('protista', this)">1. Air Kolam (Protista)</button>
                        <button class="btn btn-preparat" onclick="setMicroscope('monera', this)">2. Bakteri (Monera)</button>
                        <button class="btn btn-preparat" onclick="setMicroscope('fungi', this)">3. Jamur Roti (Fungi)</button>
                    </div>
                    
                    <div id="micro-result" class="mt-3 p-3 rounded bg-light border" style="display:none;">
                        <h6 class="font-weight-bold text-primary" id="micro-title"></h6>
                        <p class="small mb-0 text-dark" id="micro-desc"></p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mt-4 mt-lg-0">
                <div class="microscope-area">
                    <div class="lens-circle">
                        <video id="micro-view" poster="{% static 'img/lensa_kosong.png' %}" loop muted playsinline></video>
                    </div>
                    <small class="text-white-50">Perbesaran 400x</small>
                    <small id="micro-source" class="image-source text-white-50 mt-1"></small> 
                </div>
            </div>
        </div>

        <div class="pagination-footer">
            <button class="btn btn-outline-secondary btn-nav-page" onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i> Kembali
            </button>
            <div class="page-numbers-container" id="page-numbers-2"></div>
            <button id="btn-next-2" class="btn btn-outline-primary btn-nav-page" onclick="changePage(1)" disabled>
                Selanjutnya <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<div id="slide-3" class="learning-slide">
    <div class="learning-card">
        <div class="text-center mb-4">
            <h3 class="title-highlight">Kunci Determinasi</h3>
            <p class="text-content">
                Ayo identifikasi <b>5 Tumbuhan</b> berikut menggunakan Kunci Dikotom.
                Pilih ciri yang sesuai dengan gambar untuk mengetahui nama kelompoknya!
            </p>
            
            <div class="d-flex justify-content-center align-items-center mb-3">
                <span class="badge badge-primary px-3 py-2 mr-3" id="plant-counter">Tanaman 1 / 5</span>
            </div>

            <div class="plant-display">
                <img id="current-plant-img" src="" alt="Tanaman Misterius">
            </div>
            <small id="current-plant-source" class="image-source"></small> 
            <h5 class="font-weight-bold text-primary mb-3" id="current-plant-name">...</h5>
        </div>

        <div class="dikotom-container shadow-sm">
            <div class="breadcrumb-dikotom" id="dikotom-path">Mulai</div>
            <div id="question-area">
            </div>
        </div>

        <div class="text-center mt-4">
            <button id="btn-reset-plant" class="btn btn-outline-secondary btn-sm" onclick="resetDikotom()" style="display:none;"><i class="fas fa-redo mr-1"></i> Ulangi Tanaman Ini</button>
            <button id="btn-next-plant" class="btn btn-success rounded-pill ml-2" onclick="nextPlant()" style="display:none;">
                Tanaman Berikutnya <i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>

        <div class="pagination-footer">
            <button class="btn btn-outline-secondary btn-nav-page" onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i> Kembali
            </button>
            <div class="page-numbers-container" id="page-numbers-3"></div>
            <button id="btn-next-3" class="btn btn-outline-primary btn-nav-page" onclick="changePage(1)" disabled>
                Selanjutnya <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<div id="slide-4" class="learning-slide">
    <div class="learning-card">
        <h3 class="title-highlight text-center">Hierarki Taksonomi</h3>
        <p class="text-content text-center mb-4">
            Ilmuwan mengurutkan makhluk hidup dari kelompok besar ke kecil.
            <b>Klik tingkat piramida</b> untuk melihat contoh <b>Hewan</b> dan <b>Tumbuhan</b> di setiap tingkatan.
        </p>

        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="takson-pyramid">
                    <div class="takson-level" style="width: 100%;" onclick="showTaksonInfo(this, 'kingdom')">KINGDOM / REGNUM</div>
                    <div class="takson-level" style="width: 90%;" onclick="showTaksonInfo(this, 'filum')">PHYLUM / DIVISIO</div>
                    <div class="takson-level" style="width: 80%;" onclick="showTaksonInfo(this, 'kelas')">CLASSIS</div>
                    <div class="takson-level" style="width: 70%;" onclick="showTaksonInfo(this, 'ordo')">ORDO</div>
                    <div class="takson-level" style="width: 60%;" onclick="showTaksonInfo(this, 'familia')">FAMILI</div>
                    <div class="takson-level" style="width: 50%;" onclick="showTaksonInfo(this, 'genus')">GENUS</div>
                    <div class="takson-level" style="width: 40%;" onclick="showTaksonInfo(this, 'spesies')">SPECIES</div>
                </div>
            </div>

            <div class="col-md-8">
                <div id="takson-detail" class="takson-info-box text-center">
                    <i class="fas fa-arrow-left fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Klik tingkatan di samping untuk melihat detailnya.</h5>
                </div>
            </div>
        </div>

        <div class="pagination-footer">
            <button class="btn btn-outline-secondary btn-nav-page" onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i> Kembali
            </button>
            <div class="page-numbers-container" id="page-numbers-4"></div>
            
            <a id="btn-finish-modul" href="{% url 'selesai_step' 'modul_2' %}" class="btn btn-success btn-nav-page" style="display: none;">
                Selesai <i class="fas fa-check"></i>
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
<script>
// === 1. GLOBAL STATE & NAVIGATION ===
const stepNames = ["1. Ciri Kehidupan", "2. Pengamatan Mikroskopis", "3. Kunci Dikotom", "4. Tingkatan Takson"];
const totalSlides = 4;
let currentSlideIndex = 1;

// Initial State
let progressState = {
    1: true,
    2: false, 
    3: false,
    4: false
};

// --- Storage Logic ---
function loadProgress() {
    const saved = localStorage.getItem('modul_2_progress');
    if (saved) {
        progressState = JSON.parse(saved);
        // Smart Unlock: Jika level atas terbuka, level bawah otomatis terbuka
        if (progressState[4]) { progressState[3] = true; }
        if (progressState[3]) { progressState[2] = true; }
        if (progressState[2]) { progressState[1] = true; }
    }
}

function saveProgress() {
    localStorage.setItem('modul_2_progress', JSON.stringify(progressState));
}

// --- Navigation Logic ---
function nextSlide(n) {
    // Protection: Prevent jumping ahead if current slide not finished
    if (n > currentSlideIndex) {
        if (currentSlideIndex === 1 && !progressState[2]) { // Logic: if trying to go to 2 but 1 not done (mapped to state 2 unlocked)
             // Check button state directly for simplicity in logic
             if(document.getElementById('btn-next-1').disabled) {
                 alert("Silakan cek ciri Mobil DAN Kucing terlebih dahulu!");
                 return;
             }
        }
        if (currentSlideIndex === 2 && !progressState[3]) {
             if(document.getElementById('btn-next-2').disabled) {
                 alert("Silakan amati ke-3 preparat (Air Kolam, Bakteri, Jamur)!");
                 return;
             }
        }
        if (currentSlideIndex === 3 && !progressState[4]) {
             if(document.getElementById('btn-next-3').disabled) {
                 alert("Selesaikan identifikasi ke-5 tanaman terlebih dahulu!");
                 return;
             }
        }
    }

    document.querySelectorAll('.learning-slide').forEach(el => {
        el.classList.remove('active');
        el.style.opacity = 0;
    });
    
    const target = document.getElementById('slide-' + n);
    if(target) {
        target.classList.add('active');
        setTimeout(() => target.style.opacity = 1, 50);
        
        document.querySelector('.modul-header-card').scrollIntoView({behavior: 'smooth'});
        if(stepNames[n-1]) document.getElementById('step-badge').innerText = stepNames[n-1];

        currentSlideIndex = n;
        
        // Auto Unlock Previous Levels on Arrival
        if (n > 1) {
            for(let k=1; k < n; k++) {
                // If we are at slide N, slide N-1 implies next state is unlocked
                // Mapping: Slide 1 done -> state 2 true. Slide 2 done -> state 3 true.
                progressState[k+1] = true; 
            }
            saveProgress();
        }

        renderPageNumbers(n);
        checkNextButtonState(n);

        // Slide Specific Inits
        if (n === 2) {
            document.getElementById('micro-source').innerText = ''; // Reset source text
        }
        if (n === 3) {
            if (currentPlantIndex === 0 || !progressState[4]) {
                loadPlant(currentPlantIndex);
            } else {
                // If previously finished, show end state or stay at last plant
                loadPlant(currentPlantIndex); 
            }
        }
    }
}

function changePage(offset) {
    const targetPage = currentSlideIndex + offset;
    if (targetPage < 1 || targetPage > totalSlides) return;
    nextSlide(targetPage);
}

function renderPageNumbers(slideNum) {
    const container = document.getElementById(`page-numbers-${slideNum}`);
    if(!container) return;

    let html = '';
    for(let i=1; i<=totalSlides; i++) {
        let btnClass = 'btn-page-number';
        let disabledAttr = 'disabled';
        let onClickAttr = '';

        if (i === slideNum) {
            btnClass += ' active'; 
            disabledAttr = ''; 
        } else if (i < slideNum || progressState[i+1] === true || (i===1)) { 
            // Logic: Page 1 is always unlocked. Page 2 unlocked if progressState[2] is true.
            btnClass += ' unlocked'; 
            disabledAttr = '';
            onClickAttr = `onclick="nextSlide(${i})"`;
        }

        html += `<button class="${btnClass}" ${disabledAttr} ${onClickAttr}>${i}</button>`;
    }
    container.innerHTML = html;
}

function checkNextButtonState(n) {
    if (n === 1) {
        const btn = document.getElementById('btn-next-1');
        // Unlocked if progressState[2] is true (meaning slide 1 finished)
        if (progressState[2]) btn.removeAttribute('disabled');
        else btn.setAttribute('disabled', 'true');
    }
    if (n === 2) {
        const btn = document.getElementById('btn-next-2');
        if (progressState[3]) btn.removeAttribute('disabled');
        else btn.setAttribute('disabled', 'true');
    }
    if (n === 3) {
        const btn = document.getElementById('btn-next-3');
        if (progressState[4]) btn.removeAttribute('disabled');
        else btn.setAttribute('disabled', 'true');
    }
    if (n === 4) {
        // Slide 4 specific: Finish button inside content
        const btn = document.getElementById('btn-finish-modul');
        // We can create a state 5 for finish, or just reuse logic
        // Let's rely on click interaction for this one
    }
}

// === 2. SLIDE 1 LOGIC (STIMULASI) ===
let checked1 = false;
let checked2 = false;
function checkCiri(type) {
    if(type === 'mobil') {
        document.getElementById('list-mobil').style.display = 'block';
        document.getElementById('res-mobil').style.display = 'block';
        checked1 = true;
    } else {
        document.getElementById('list-kucing').style.display = 'block';
        document.getElementById('res-kucing').style.display = 'block';
        checked2 = true;
    }
    
    if(checked1 && checked2) {
        progressState[2] = true; // Unlock slide 2
        saveProgress();
        document.getElementById('btn-next-1').removeAttribute('disabled');
        renderPageNumbers(1);
    }
}

// === 3. SLIDE 2 LOGIC (MIKROSKOP) ===
const slidesMicro = {
    'protista': { 
        video: "{% static 'video/airkolam.mp4' %}", 
        title: "Kingdom Protista (Eukariotik Uniseluler)", 
        desc: "Ditemukan Paramecium/Amoeba! Organisme **uniseluler** (sel tunggal) yang sudah memiliki **membran inti (eukariotik)**. Perhatikan pergerakannya yang aktif. Ini bukan hewan, tumbuhan, atau jamur sejati.",
        source: "Christian Linkenheld - Mikroskopie (YouTube)"
    },
    'monera': { 
        video: "{% static 'video/bakteri.mp4' %}", 
        title: "Kingdom Monera (Prokariotik)", 
        desc: "Ini adalah Bakteri. Ciri utamanya adalah **TIDAK memiliki membran inti (prokariotik)**. Mereka adalah organisme paling sederhana dan umumnya **uniseluler**. Ukurannya jauh lebih kecil dari Protista.",
        source: "Anson Call (YouTube)"
    },
    'fungi': { 
        video: "{% static 'video/jamurroti.mp4' %}", 
        title: "Kingdom Fungi (Eukariotik Heterotrof)", 
        desc: "Tampak benang-benang halus yang disebut **hifa**. Jamur adalah **eukariotik** tetapi **heterotrof** (tidak berfotosintesis). Mereka mencerna makanan di luar tubuh (Saprofit).",
        source: "Amaliyah (YouTube)"
    }
};

let preparatDilihat = new Set();
let allPreparat = ['protista', 'monera', 'fungi'];

function mdToHtmlBold(text) {
    return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
}

function setMicroscope(type, btn) {
    document.querySelectorAll('.btn-preparat').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const data = slidesMicro[type];
    const video = document.getElementById('micro-view');
    video.src = data.video;
    video.load();
    video.play().catch(e => console.log("Auto-play prevented"));
    
    document.getElementById('micro-title').innerText = data.title;
    document.getElementById('micro-desc').innerHTML = mdToHtmlBold(data.desc); 
    document.getElementById('micro-result').style.display = 'block';
    document.getElementById('micro-source').innerText = 'Sumber Video: ' + data.source;

    if (allPreparat.includes(type)) {
        preparatDilihat.add(type);
    }
    
    if (preparatDilihat.size === allPreparat.length) {
        progressState[3] = true; // Unlock slide 3
        saveProgress();
        document.getElementById('btn-next-2').removeAttribute('disabled');
        renderPageNumbers(2);
    }
}

// === 4. SLIDE 3 LOGIC (DIKOTOM) ===
const plantsQueue = [
    { name: "Tanaman A (Suplir)", img: "{% static 'img/suplir.jpeg' %}", source: "Sumber: Greeners.Co", correctResult: "Paku (Pteridophyta)" },
    { name: "Tanaman B (Lumut)", img: "{% static 'img/lumut.jpeg' %}", source: "Sumber: detikcom", correctResult: "Lumut (Bryophyta)" },
    { name: "Tanaman C (Melinjo)", img: "{% static 'img/melinjo.jpeg' %}", source: "Sumber: radarsurabaya.id", correctResult: "Gymnospermae (Melinjo)" },
    { name: "Tanaman D (Jagung)", img: "{% static 'img/jagung3.jpg' %}", source: "Sumber: Corteva.id", correctResult: "Monokotil (Jagung)" },
    { name: "Tanaman E (Kacang)", img: "{% static 'img/kacang-tanah.jpg' %}", source: "Sumber: BibitBunga.com", correctResult: "Dikotil (Kacang/Mangga)" }
];
let currentPlantIndex = 0;
const dikotomQuestions = {
    '1': { q: "1. Apakah tumbuhan ini memiliki spora?", a: {text: "1a. Berspora", next: '2'}, b: {text: "1b. Tidak Berspora", next: '3'} },
    '2': { q: "2. Apakah batangnya terlihat jelas?", a: {text: "2a. Batang Jelas", res: "Paku (Pteridophyta)"}, b: {text: "2b. Batang Tidak Jelas", res: "Lumut (Bryophyta)"} },
    '3': { q: "3. Bagaimana keadaan bijinya?", a: {text: "3a. Biji Tertutup", next: '4'}, b: {text: "3b. Biji Terbuka", res: "Gymnospermae (Melinjo)"} },
    '4': { q: "4. Berapa keping bijinya?", a: {text: "4a. Berkeping Dua", res: "Dikotil (Kacang/Mangga)"}, b: {text: "4b. Berkeping Satu", res: "Monokotil (Jagung)"} }
};

function loadPlant(index) {
    const plant = plantsQueue[index];
    document.getElementById('current-plant-img').src = plant.img;
    document.getElementById('current-plant-name').innerText = plant.name;
    document.getElementById('plant-counter').innerText = `Tanaman ${index + 1} / ${plantsQueue.length}`;
    document.getElementById('btn-next-plant').style.display = 'none';
    document.getElementById('btn-reset-plant').style.display = 'block';
    document.getElementById('current-plant-source').innerText = plant.source;

    renderDikotom('1');
    document.getElementById('dikotom-path').innerText = "Mulai";
}

function renderDikotom(qId) {
    const data = dikotomQuestions[qId];
    const area = document.getElementById('question-area');
    let html = `<div class="question-text">${data.q}</div>`;
    if(data.a.res) {
        html += `<button class="btn-choice" onclick="checkAnswer('${data.a.res}', true)">${data.a.text}</button>`;
    } else {
        html += `<button class="btn-choice" onclick="nextStep('${data.a.next}', '${data.a.text}')">${data.a.text}</button>`;
    }
    if(data.b.res) {
        html += `<button class="btn-choice" onclick="checkAnswer('${data.b.res}', false)">${data.b.text}</button>`;
    } else {
        html += `<button class="btn-choice" onclick="nextStep('${data.b.next}', '${data.b.text}')">${data.b.text}</button>`;
    }
    area.innerHTML = html;
}

function nextStep(nextId, text) {
    document.getElementById('dikotom-path').innerHTML += " &rarr; " + text;
    renderDikotom(nextId);
}

function checkAnswer(result) {
    const target = plantsQueue[currentPlantIndex].correctResult;
    const area = document.getElementById('question-area');
    if (result === target) {
        area.innerHTML = `<div class="alert alert-success p-4 text-center"><h1 class="display-4"><i class="fas fa-check-circle text-success"></i></h1><h5 class="font-weight-bold">IDENTIFIKASI TEPAT!</h5><p>Tanaman ini benar adalah <strong>${result}</strong>.</p></div>`;
        if (currentPlantIndex < plantsQueue.length - 1) {
            document.getElementById('btn-next-plant').style.display = 'inline-block';
            document.getElementById('btn-reset-plant').style.display = 'none';
        } else {
            // FINISH ALL PLANTS
            progressState[4] = true; // Unlock Slide 4
            saveProgress();
            
            document.getElementById('btn-next-3').removeAttribute('disabled');
            document.getElementById('btn-reset-plant').style.display = 'none';
            renderPageNumbers(3);
        }
    } else {
        area.innerHTML = `<div class="alert alert-warning p-4 text-center"><h5 class="font-weight-bold">Kurang Tepat</h5><p>Kamu memilih: <strong>${result}</strong>.</p><button class="btn btn-outline-primary mt-2" onclick="resetDikotom()">Ulangi Identifikasi</button></div>`;
    }
}

function nextPlant() {
    currentPlantIndex++;
    loadPlant(currentPlantIndex);
}

function resetDikotom() {
    document.getElementById('dikotom-path').innerText = "Mulai";
    renderDikotom('1');
}

// === 5. SLIDE 4 LOGIC (TAKSON) ===
const taksonEnriched_v4 = {
    'kingdom': {
        latin: 'REGNUM / KINGDOM', indo: 'Dunia (Kerajaan)', desc: '**Kelompok paling besar.** Anggotanya sangat banyak.',
        hewan: { nama_level: 'Kingdom Animalia', ciri_level: 'Heterotrof, Multiseluler.', items: [{ nama: 'Kucing', img: "{% static 'img/kucing.jpeg' %}", info: 'Mamalia', source: 'Dokumen Canva' }, { nama: 'Cacing Tanah', img: "{% static 'img/cacing.jpg' %}", info: 'Invertebrata', source: 'IPB University.com' }] },
        tumbuhan: { nama_level: 'Regnum Plantae', ciri_level: 'Autotrof, Multiseluler.', items: [{ nama: 'Jagung', img: "{% static 'img/jagung3.jpg' %}", info: 'Berbunga', source: 'Corteva.id' }, { nama: 'Lumut', img: "{% static 'img/lumut.jpeg' %}", info: 'Tidak Berpembuluh', source: 'detikcom' }] }
    },
    'filum': {
        latin: 'DIVISIO / PHYLUM', indo: 'Divisi (Filum)', desc: 'Mengelompokkan berdasarkan rencana dasar tubuh.',
        hewan: { nama_level: 'Phylum Chordata', ciri_level: 'Memiliki notokorda/tulang belakang.', items: [{ nama: 'Kucing', img: "{% static 'img/tulangbelakangkucing.jpg' %}", info: 'Bertulang belakang', source: 'Syok.My' }] },
        tumbuhan: { nama_level: 'Divisio Spermatophyta', ciri_level: 'Berkembang biak dengan biji.', items: [{ nama: 'Jagung (Biji)', img: "{% static 'img/jagungbiji2.jpg' %}", info: 'Angiospermae', source: 'Pinterest' }] }
    },
    'kelas': {
        latin: 'CLASSIS', indo: 'Kelas', desc: 'Kelompok dengan ciri yang lebih spesifik.',
        hewan: { nama_level: 'Classis Mammalia', ciri_level: 'Menyusui anak.', items: [{ nama: 'Kucing', img: "{% static 'img/kucingmenyusui.jpg' %}", info: 'Menyusui', source: 'Kompas.com' }] },
        tumbuhan: { nama_level: 'Classis Monocotyledoneae', ciri_level: 'Biji berkeping satu.', items: [{ nama: 'Jagung', img: "{% static 'img/jagung3.jpg' %}", info: '1 Keping', source: 'Corteva.id' }] }
    },
    'ordo': {
        latin: 'ORDO', indo: 'Bangsa', desc: 'Kemiripan pada bentuk tubuh dan cara hidup.',
        hewan: { nama_level: 'Ordo Carnivora', ciri_level: 'Pemakan daging.', items: [{ nama: 'Kucing', img: "{% static 'img/kucingmakan.png' %}", info: 'Makan Daging', source: 'Betahita.com' }] },
        tumbuhan: { nama_level: 'Ordo Poales', ciri_level: 'Rumput-rumputan.', items: [{ nama: 'Jagung', img: "{% static 'img/jagung3.jpg' %}", info: 'Poaceae', source: 'Corteva.id' }] }
    },
    'familia': {
        latin: 'FAMILI', indo: 'Suku', desc: 'Marga yang berkerabat dekat.',
        hewan: { nama_level: 'Famili Felidae', ciri_level: 'Keluarga Kucing.', items: [{ nama: 'Kucing', img: "{% static 'img/kucing.jpeg' %}", info: 'Felidae', source: 'Dokumen Canva' }] },
        tumbuhan: { nama_level: 'Famili Poaceae', ciri_level: 'Rumput sejati.', items: [{ nama: 'Jagung', img: "{% static 'img/jagung3.jpg' %}", info: 'Beruas', source: 'Corteva.id' }] }
    },
    'genus': {
        latin: 'GENUS', indo: 'Marga', desc: 'Kelompok spesies yang paling dekat.',
        hewan: { nama_level: 'Genus Felis', ciri_level: 'Kucing kecil.', items: [{ nama: 'Kucing Rumah', img: "{% static 'img/kucingspesies.jpeg' %}", info: 'Felis catus', source: 'Kompas.com' }] },
        tumbuhan: { nama_level: 'Genus Zea', ciri_level: 'Jenis jagung.', items: [{ nama: 'Jagung', img: "{% static 'img/tanamanjagung.jpg' %}", info: 'Zea mays', source: 'GDM Organik.com' }] }
    },
    'spesies': {
        latin: 'SPECIES', indo: 'Spesies', desc: 'Kelompok dasar, bisa kawin dan fertil.',
        hewan: { nama_level: 'Species Felis catus', ciri_level: 'Spesies tunggal.', items: [{ nama: 'Kucing Rumah', img: "{% static 'img/kucing.jpeg' %}", info: 'Felis catus', source: 'Dokumen Canva' }] },
        tumbuhan: { nama_level: 'Species Zea mays', ciri_level: 'Spesies tunggal.', items: [{ nama: 'Jagung', img: "{% static 'img/tanamanjagung.jpg' %}", info: 'Zea mays', source: 'GDM Organik.com' }] }
    }
};

function showTaksonInfo(el, key) {
    document.querySelectorAll('.takson-level').forEach(d => d.classList.remove('active'));
    el.classList.add('active');

    const data = taksonEnriched_v4[key];
    const box = document.getElementById('takson-detail');

    function createImageCard(item, colClass) {
        return `<div class="${colClass} mb-4">
                <div class="takson-image-card shadow-sm">
                    <img src="${item.img}" alt="${item.nama}">
                    <div class="caption">${item.nama}</div>
                    <span class="sub-caption">${item.info}</span>
                    <small class="image-source">Sumber: ${item.source}</small> 
                </div>
            </div>`;
    }

    function createInfoGroup(type, groupData) {
        const isHewan = type === 'Hewan';
        const color = isHewan ? 'primary' : 'success';
        const icon = isHewan ? 'paw' : 'leaf';
        const colClass = groupData.items.length === 1 ? 'col-12 col-lg-6 offset-lg-3' : 'col-md-6'; 

        let imagesHTML = '';
        groupData.items.forEach(item => { imagesHTML += createImageCard(item, colClass); });

        return `<div class="col-12 mt-4">
                <div class="takson-group-wrapper border border-${color} rounded p-3">
                    <h5 class="takson-group-title text-${color} mb-2">
                        <i class="fas fa-${icon} mr-1"></i> <b>Kelompok ${type}</b>: ${groupData.nama_level}
                    </h5>
                    <p class="small text-muted font-weight-bold">Ciri Khas Kelompok: ${groupData.ciri_level}</p>
                    <div class="row">${imagesHTML}</div>
                </div>
            </div>`;
    }

    const groupsHTML = `<div class="row">${createInfoGroup('Hewan', data.hewan)}${createInfoGroup('Tumbuhan', data.tumbuhan)}</div>`;
    let latinDisplay = data.latin.split(' / ');
    
    box.innerHTML = `<div class="animated fadeIn">
            <div class="takson-latin-box">
                <span class="takson-label">Tumbuhan:</span> <span class="takson-latin-plant">${latinDisplay[0]}</span>
                <span class="text-dark mx-2">|</span>
                <span class="takson-label">Hewan:</span> <span class="takson-latin-animal">${latinDisplay[1] ? latinDisplay[1] : latinDisplay[0]}</span>
            </div>
            <div class="takson-indo">${data.indo}</div>
            <p class="text-content text-center mb-1 mt-2" style="font-style: italic;">${mdToHtmlBold(data.desc)}</p> 
            ${groupsHTML}
        </div>`;
    
    // Reveal Finish Button
    document.getElementById('btn-finish-modul').style.display = 'inline-block';
}

// === INIT ===
document.addEventListener('DOMContentLoaded', () => {
    loadProgress(); 
    checkNextButtonState(1);
    renderPageNumbers(1);
    loadPlant(currentPlantIndex);
});
</script>
{% endblock %}